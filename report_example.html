<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>How to add a new XLS report &#8212; The SchoolTool Book</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/flourish.css?v=c4462e41" />
    
    <script src="_static/documentation_options.js?v=841abef3"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/jquery.colorbox-min.js"></script>
    <script src="_static/flourish.js"></script>
    
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Ark project specific functionality" href="ark.html" />
    <link rel="prev" title="SchoolTool User Interface Guidelines" href="ui_guidelines.html" />
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Ubuntu:regular,bold&subset=Latin" />

  </head><body>
<div class="schooltool">
  <div class="header">
    <h1 class="brand">
      <a href="http://www.schooltool.org/">
        <span class="school">school</span><span class="tool">tool</span>
        <img alt="Logo" src="_static/logo-small.png" />
      </a>
    </h1>
    <ul class="navigation">
      <li>
        <a href="http://schooltool.org/">
          Home
        </a>
      </li>
      <li>
        <a href="features.html">
          Features
        </a>
      </li>
      <li>
        <a href="http://launchpad.net/schooltool-project/+announcements">
          News
        </a>
      </li>
      <li>
        <a href="screenshots.html">
          Screenshots
        </a>
      </li>
      <li>
        <a href="system-requirements.html">
          Download
        </a>
      </li>
      <li>
        <a href="index.html">
          Documentation
        </a>
      </li>
      <li>
        <a href="about.html">
          Contact
        </a>
      </li>
    </ul>
    <script type="text/javascript">
      $(document).ready(function() {
        $(window).scroll(function() {
          var scrollTop = $(window).scrollTop();
          if (scrollTop > 64) {
            $('div.related').css('position', 'fixed');
            $('div.related').css('top', '0');
          } else {
            $('div.related').css('position', 'absolute');
            $('div.related').css('top', '64px');
          }
        });
      });
    </script>
    
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="ark.html" title="Ark project specific functionality"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="ui_guidelines.html" title="SchoolTool User Interface Guidelines"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">The SchoolTool Book</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="developers.html" accesskey="U">Developers’ Handbook</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">How to add a new XLS report</a></li> 
      </ul>
    </div>
<!-- Search Bar -->
<div id="search-box">
  <form class="search-form" id="google-appliance-search-form" method="get"
        accept-charset="UTF-8"
        action="search.html">
      <div>
        <div id="edit-keys-wrapper" class="form-item">
          <input type="text" class="form-text"
                 onfocus="if(this.value=='Type to search'){this.value=''}"
                 onblur="if(this.value==''){this.value='Type to search';}"
                 value="Type to search" size="20" id="edit-keys" name="q"
                 maxlength="255" />
            <input type="hidden" value="yes" name="check_keywords" />
            <input type="hidden" value="default" name="area" />
        </div>
        <img src="_static/arrow.png" class="form-submit"
             onclick="$(this).closest('form').submit()"
             style="cursor: pointer" />
      </div>
    </form>
  </div>
  <!-- End Search Bar -->
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="how-to-add-a-new-xls-report">
<h1>How to add a new XLS report<a class="headerlink" href="#how-to-add-a-new-xls-report" title="Link to this heading">¶</a></h1>
<p>We’re going to demonstrate how to add an XLS report with a table for listing the streams in a school year (rows) and the attendance rate for each stream in each month (columns).</p>
<p>We’re going to assume that we’re working on a made-up SchoolTool package called <code class="docutils literal notranslate"><span class="pre">schooltool.myreport</span></code> with three empty files:</p>
<blockquote>
<div><ul class="simple">
<li><p>__init__.py</p></li>
<li><p>configure.zcml</p></li>
<li><p>report.py</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can find the code of the <a class="reference external" href="https://code.launchpad.net/~replaceafill/+junk/schooltool.myreport">schooltool.myreport package</a> in Launchpad.</p>
</div>
<p>Let’s first add a root directive and namespaces we’re going to need in <code class="docutils literal notranslate"><span class="pre">configure.zcml</span></code>:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;configure</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;http://namespaces.zope.org/browser&quot;</span>
<span class="w">           </span><span class="na">xmlns:zope=</span><span class="s">&quot;http://namespaces.zope.org/zope&quot;</span>
<span class="w">           </span><span class="na">xmlns:i18n=</span><span class="s">&quot;http://namespaces.zope.org/i18n&quot;</span>
<span class="w">           </span><span class="na">xmlns:flourish=</span><span class="s">&quot;http://schooltool.org/flourish&quot;</span>
<span class="w">           </span><span class="na">xmlns:report=</span><span class="s">&quot;http://namespaces.schooltool.org/report&quot;</span>
<span class="w">           </span><span class="na">i18n_domain=</span><span class="s">&quot;schooltool.myreport&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/configure&gt;</span>
</pre></div>
</div>
<p>The first step when a view component is designed is to decide its “context”. It’s usually a persistent object in the database and it’s referenced as the <code class="docutils literal notranslate"><span class="pre">context</span></code> attribute of the view components.  You want the context to be as narrow as practical.  In this case we’ll use the <code class="docutils literal notranslate"><span class="pre">SchoolYear</span></code> object, because we know each report will be limited to a selected year.  Other common reports use <code class="docutils literal notranslate"><span class="pre">Person</span></code> as a context, or use <code class="docutils literal notranslate"><span class="pre">Group</span></code> or <code class="docutils literal notranslate"><span class="pre">Section</span></code> as a context to iterate over the members of a group.</p>
<p>Then we need to register a “link” in ZCML to create a HTML link in the user interface for accessing the report. For school year reports, and other common contexts, there’s already a component (<code class="docutils literal notranslate"><span class="pre">YearReportsLinks</span></code>) in charge of handling those links and there is a special directive for registering them (<code class="docutils literal notranslate"><span class="pre">report:reportLink</span></code>). Inside the <code class="docutils literal notranslate"><span class="pre">&lt;configure&gt;&lt;/configure&gt;</span></code> element of <code class="docutils literal notranslate"><span class="pre">configure.zcml</span></code> add:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nt">&lt;report:reportLink</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="na">name=</span><span class="s">&quot;attendance_report&quot;</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="na">class=</span><span class="s">&quot;.report.AttendanceReportLinkViewlet&quot;</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="na">manager=</span><span class="s">&quot;schooltool.report.browser.report.YearReportsLinks&quot;</span>
<span class="linenos"> 5</span><span class="w">    </span><span class="na">permission=</span><span class="s">&quot;schooltool.edit&quot;</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="na">group=</span><span class="s">&quot;School Year&quot;</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="na">title=</span><span class="s">&quot;Attendance demo report&quot;</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="na">description=</span><span class="s">&quot;This is a sample attendance report&quot;</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="na">file_type=</span><span class="s">&quot;xls&quot;</span>
<span class="linenos">10</span><span class="w">    </span><span class="na">link=</span><span class="s">&quot;request_attendance_report.html”</span>
<span class="linenos">11</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p>Let’s explain this directive line by line:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">reportLink</span></code> directive comes from the <code class="docutils literal notranslate"><span class="pre">report</span></code> namespace (see the <code class="docutils literal notranslate"><span class="pre">meta.zcml</span></code> file in the <code class="docutils literal notranslate"><span class="pre">schooltool.report</span></code> package) and it’s handled by the <code class="docutils literal notranslate"><span class="pre">schooltool.report.meta.reportLinkDirective</span></code> function.</p></li>
<li><p>A unique name is used to register the link component in the app’s component registry.</p></li>
<li><p>We use a custom class for rendering the link. We’ll add this class later.  The component we’re implementing in this step is called a <code class="docutils literal notranslate"><span class="pre">viewlet</span></code> (in charge of rendering a piece of HTML in a specific place in the page).</p></li>
<li><p>The manager is a component that filters the viewlets, for example, by permission, and prepares them for rendering.</p></li>
<li><p>Permission refers to an existing permission in the system.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">group</span></code> is used to attempt to generate useful links on the report overview page, which lists all the reports registered on the system.  In general this maps to the context.</p></li>
<li><p>Title is the text used in the user interface for the link to the report.</p></li>
<li><p>The description the report is used in the request dialog of the report. We’ll add this dialog later.</p></li>
<li><p>Filetype is also used for the request dialog of the report.</p></li>
<li><p>The link is a view name that references the request dialog of the report. You’ll see how the link implementation accesses this attribute and concatenates it with the year’s full URL</p></li>
<li><p>We close the empty directive</p></li>
</ol>
</div></blockquote>
<p>Now let’s implement the link class. All this component does is to render the right path for the request dialog for the school year. In the <code class="docutils literal notranslate"><span class="pre">report.py</span></code> module add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">zope.traversing.browser.absoluteurl</span> <span class="kn">import</span> <span class="n">absoluteURL</span>
<span class="kn">from</span> <span class="nn">schooltool.app.browser.app</span> <span class="kn">import</span> <span class="n">ActiveSchoolYearContentMixin</span>
<span class="kn">from</span> <span class="nn">schooltool.report.report</span> <span class="kn">import</span> <span class="n">ReportLinkViewlet</span>

<span class="k">class</span> <span class="nc">AttendanceReportLinkViewlet</span><span class="p">(</span>
    <span class="n">ReportLinkViewlet</span><span class="p">,</span>           <span class="c1"># renders the report link</span>
    <span class="n">ActiveSchoolYearContentMixin</span> <span class="c1"># set the schoolyear attribute</span>
<span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">report_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">schoolyear_url</span> <span class="o">=</span> <span class="n">absoluteURL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schoolyear</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">schoolyear_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">)</span>
</pre></div>
</div>
<p>Then let’s register and implement the <code class="docutils literal notranslate"><span class="pre">request_attendance_report.html</span></code> view for the school year referenced in the previous step. First we register it:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;flourish:page</span>
<span class="w">    </span><span class="na">name=</span><span class="s">&quot;request_attendance_report.html&quot;</span>
<span class="w">    </span><span class="na">for=</span><span class="s">&quot;schooltool.schoolyear.interfaces.ISchoolYear&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;.report.AttendanceReportRequestView&quot;</span>
<span class="w">    </span><span class="na">permission=</span><span class="s">&quot;schooltool.edit&quot;</span>
<span class="w">    </span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p>Then we implement the request dialog view. In this case this is a simple class with just an attribute pointing to the name of the component that will render the XLS report. In more advanced cases this dialog can also become a form and react dynamically to user inputs:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">schooltool.export.export</span> <span class="kn">import</span> <span class="n">RequestXLSReportDialog</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">AttendanceReportRequestView</span><span class="p">(</span>
    <span class="n">RequestXLSReportDialog</span> <span class="c1"># renders the request dialog</span>
<span class="p">):</span>
    <span class="n">report_builder</span> <span class="o">=</span> <span class="s1">&#39;attendance_report.xls&#39;</span>
</pre></div>
</div>
<p>Request dialog views in SchoolTool create and schedule Celery tasks that run the XLS or PDF reports as background jobs.</p>
<p>Now let’s register and implement the <code class="docutils literal notranslate"><span class="pre">attendance_report.xls</span></code> view. Again registration comes first:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;flourish:page</span>
<span class="w">    </span><span class="na">name=</span><span class="s">&quot;attendance_report.xls&quot;</span>
<span class="w">    </span><span class="na">for=</span><span class="s">&quot;schooltool.schoolyear.interfaces.ISchoolYear&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;.report.AttendanceReportView&quot;</span>
<span class="w">    </span><span class="na">permission=</span><span class="s">&quot;schooltool.edit&quot;</span>
<span class="w">    </span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p>We are going to break the implementation up to make it more understandable. First we subclass the base view for XLS reports:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">schooltool.export.export</span> <span class="kn">import</span> <span class="n">ExcelExportView</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">AttendanceReportView</span><span class="p">(</span><span class="n">ExcelExportView</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>The context for our view is a <code class="docutils literal notranslate"><span class="pre">SchoolYear</span></code> object. We can add a property for making things easier to understand:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">schoolyear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>
</pre></div>
</div>
<p>For getting the months in the school year, first we need to query its terms. Here we sort them by starting date and add them as a “lazy” property (that’s only calculated once):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">zope.cachedescriptors.property</span> <span class="kn">import</span> <span class="n">Lazy</span>
<span class="o">...</span>
    <span class="nd">@Lazy</span>
    <span class="k">def</span> <span class="nf">terms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schoolyear</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">term</span><span class="p">:</span> <span class="n">term</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
</pre></div>
</div>
<p>Then we’ll add a <code class="docutils literal notranslate"><span class="pre">months</span></code> property. Months will be represented as an ordered dictionary with its keys being (year, month_name) combinations and its values being sets of school day dates. We’re going to reuse a component for calculating the school days in a month and a function for parsing ISO-8601 “YYYY-MM-DD” strings:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">schooltool.common</span> <span class="kn">import</span> <span class="n">parse_date</span>
<span class="kn">from</span> <span class="nn">schooltool.term.browser.term</span> <span class="kn">import</span> <span class="n">TermRenderer</span>
<span class="o">...</span>
    <span class="nd">@Lazy</span>
    <span class="k">def</span> <span class="nf">months</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">month_data</span> <span class="ow">in</span> <span class="n">TermRenderer</span><span class="p">(</span><span class="n">term</span><span class="p">)</span><span class="o">.</span><span class="n">calendar</span><span class="p">():</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">month_data</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span>
                <span class="n">month_name</span> <span class="o">=</span> <span class="n">month_data</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span>
                <span class="n">month_key</span> <span class="o">=</span> <span class="n">year</span><span class="p">,</span> <span class="n">month_name</span>
                <span class="k">if</span> <span class="n">month_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">month_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">dates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">week_data</span> <span class="ow">in</span> <span class="n">month_data</span><span class="p">[</span><span class="s1">&#39;weeks&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">day_data</span> <span class="ow">in</span> <span class="n">week_data</span><span class="p">[</span><span class="s1">&#39;days&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">day_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">dates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">parse_date</span><span class="p">(</span><span class="n">day_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]))</span>
                <span class="n">result</span><span class="p">[</span><span class="n">month_key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dates</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>Now we need to convert the dates in each month into “meetings”. We could have done this in a single step, but we split it for clarity:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">schooltool.lyceum.journal.browser.journal</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">makeSchoolAttendanceMeeting</span>
<span class="p">)</span>
<span class="o">...</span>
    <span class="nd">@Lazy</span>
    <span class="k">def</span> <span class="nf">meetings_by_month</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">month_key</span><span class="p">,</span> <span class="n">dates</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">months</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">month_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">makeSchoolAttendanceMeeting</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>Since this is an attendance report for students we need to get the score system used in the Student Attendance view. We can do it like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">schooltool.app.interfaces</span> <span class="kn">import</span> <span class="n">ISchoolToolApplication</span>
<span class="kn">from</span> <span class="nn">schooltool.lyceum.journal.interfaces</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IJournalScoreSystemPreferences</span>
<span class="p">)</span>
<span class="o">...</span>
    <span class="nd">@Lazy</span>
    <span class="k">def</span> <span class="nf">scoresystem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">ISchoolToolApplication</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">journal_preferences</span> <span class="o">=</span> <span class="n">IJournalScoreSystemPreferences</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">journal_preferences</span><span class="o">.</span><span class="n">student_scoresystem</span>
</pre></div>
</div>
<p>The next step is to determine which “sessions” are enabled in the system and get requirement factories for them:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">schooltool.lyceum.journal.interfaces</span> <span class="kn">import</span> <span class="n">IAttendanceOptions</span>
<span class="kn">from</span> <span class="nn">schooltool.lyceum.journal.journal</span> <span class="kn">import</span> <span class="n">StudentAMRequirement</span>
<span class="kn">from</span> <span class="nn">schooltool.lyceum.journal.journal</span> <span class="kn">import</span> <span class="n">StudentPMRequirement</span>
<span class="o">...</span>
    <span class="nd">@Lazy</span>
    <span class="k">def</span> <span class="nf">requirement_factories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">ISchoolToolApplication</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">attendance_options</span> <span class="o">=</span> <span class="n">IAttendanceOptions</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attendance_options</span><span class="o">.</span><span class="n">students_am_enabled</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">StudentAMRequirement</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attendance_options</span><span class="o">.</span><span class="n">students_pm_enabled</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">StudentPMRequirement</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>Now, we’ll call our requirement factories for each meeting in each month to get “requirement” objects (used to retrieve evaluations):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
    <span class="nd">@Lazy</span>
    <span class="k">def</span> <span class="nf">requirements_by_month</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">month_key</span><span class="p">,</span> <span class="n">meetings</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meetings_by_month</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">month_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">factory</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirement_factories</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">meeting</span> <span class="ow">in</span> <span class="n">meetings</span><span class="p">:</span>
                    <span class="n">requirement</span> <span class="o">=</span> <span class="n">factory</span><span class="p">(</span><span class="n">meeting</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">month_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">requirement</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>Next, we need access to all the streams in the year, so we can add a property for getting the <code class="docutils literal notranslate"><span class="pre">StreamContainer</span></code> object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">schooltool.stream.interfaces</span> <span class="kn">import</span> <span class="n">IStreamContainer</span>
<span class="o">...</span>
    <span class="nd">@Lazy</span>
    <span class="k">def</span> <span class="nf">streams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">IStreamContainer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schoolyear</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                      <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">stream</span><span class="p">:</span> <span class="n">stream</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, let’s add a method for calculating the attendance rate of a stream in a given month. We’re going to use the same key (year, month_name) we’ve been using to represent a month:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">schooltool.requirement.interfaces</span> <span class="kn">import</span> <span class="n">IEvaluations</span>
<span class="kn">from</span> <span class="nn">schooltool.requirement.scoresystem</span> <span class="kn">import</span> <span class="n">UNSCORED</span>
<span class="o">...</span>

    <span class="nd">@Lazy</span>
    <span class="k">def</span> <span class="nf">not_present_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="n">ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoresystem</span>
       <span class="n">not_present_scores</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">tag_absent</span> <span class="o">+</span> <span class="n">ss</span><span class="o">.</span><span class="n">tag_excused</span> <span class="o">+</span> <span class="n">ss</span><span class="o">.</span><span class="n">tag_skip</span>
       <span class="c1"># returned as a dictionary for faster look up</span>
       <span class="k">return</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">not_present_scores</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stream_attendance_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">month_key</span><span class="p">):</span>
        <span class="n">month_requirements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirements_by_month</span><span class="p">[</span><span class="n">month_key</span><span class="p">]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">present</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">student</span> <span class="ow">in</span> <span class="n">stream</span><span class="o">.</span><span class="n">members</span><span class="p">:</span>
            <span class="n">evaluations</span> <span class="o">=</span> <span class="n">IEvaluations</span><span class="p">(</span><span class="n">student</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">requirement</span> <span class="ow">in</span> <span class="n">month_requirements</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">evaluations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">requirement</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">score</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">UNSCORED</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">score</span><span class="o">.</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_present_scores</span><span class="p">:</span>
                        <span class="n">present</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">present</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, let’s make the report “callable” by adding a <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method. This is the method that will get called by the Zope framework when the report is requested:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">import</span> <span class="nn">xlwt</span>
<span class="o">...</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">workbook</span> <span class="o">=</span> <span class="n">xlwt</span><span class="o">.</span><span class="n">Workbook</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_report</span><span class="p">(</span><span class="n">workbook</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">workbook</span>
</pre></div>
</div>
<p>We create a <code class="docutils literal notranslate"><span class="pre">Workbook</span></code> object from the <a class="reference external" href="http://xlwt.readthedocs.io">xlwt library</a>, pass it to the <code class="docutils literal notranslate"><span class="pre">build_report</span></code> method that we’re going to code later and that is going to modify its contents, and finally return it so that the report machinery extracts its data and make it downloadable (by attaching it to a persistent <code class="docutils literal notranslate"><span class="pre">Message</span></code> object).</p>
<p>Finally let’s add our <code class="docutils literal notranslate"><span class="pre">build_report</span></code> method:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>We’re going to add a sheet to the workbook titled “Attendance report”</p></li>
<li><p>We’re going to print the names of the months in the first row, starting on the second column</p></li>
<li><p>We’re going to print the names of the streams in the first column, starting on the second row</p></li>
<li><p>We’re going to traverse each stream, then we’re going to traverse each month to finally get the attendance rate for that stream in that month</p></li>
</ol>
</div></blockquote>
<p>This method looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workbook</span><span class="p">):</span>
    <span class="c1"># add a sheet with a title to the workbook</span>
    <span class="n">worksheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_sheet</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Attendance report&#39;</span><span class="p">)</span>

    <span class="c1"># print the name of the months in the first row</span>
    <span class="c1"># starting on the second column</span>
    <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">col</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dates</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">months</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month_name</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_header</span><span class="p">(</span><span class="n">worksheet</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">month_name</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># print the name of the streams in the first column</span>
    <span class="c1"># starting on the second row</span>
    <span class="n">row</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">streams</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_header</span><span class="p">(</span><span class="n">worksheet</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">stream</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># traverse each stream</span>
    <span class="c1"># then traverse each month</span>
    <span class="c1"># finally print the attendance rate for that stream in that month</span>
    <span class="c1"># use percentages in the cell values</span>
    <span class="n">row</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">streams</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">month_key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">months</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">worksheet</span><span class="p">,</span>
                <span class="n">row</span><span class="p">,</span>
                <span class="n">col</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stream_attendance_rate</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">month_key</span><span class="p">),</span>
                <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;0%&#39;</span>
            <span class="p">)</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>The report would look like this:</p>
<blockquote>
<div><img alt="_images/myreport.png" src="_images/myreport.png" />
</div></blockquote>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="ui_guidelines.html"
                          title="previous chapter">SchoolTool User Interface Guidelines</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="ark.html"
                          title="next chapter">Ark project specific functionality</a></p>
  </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    <p class="copyright">
        &copy; Copyright 2014, the Shuttleworth Foundation.  This work is licensed under the Creative Commons Attribution 3.0 Unported License.
    </p>
    <p>
      Last updated on Dec 14, 2024.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.4.7.
    <a href="_sources/report_example.rst.txt"
             rel="nofollow">Show Source</a>
    </p>
  </div>
</div>
  </body>
</html>